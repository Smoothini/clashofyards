<div class="space-y-4">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 capitalize">
        {% if category == "locker" %}
            Monster Locker
        {% elif category == "academy" %}
            Monster Academy
        {% elif category == "lab" %}
            Monster Lab
        {% else %}
            {{ category }} Monsters
        {% endif %}
    </h2>
    
    {% for monster in monsters %}
    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm {% if not monster.unlocked %}opacity-75 bg-gray-50{% endif %}">
        <div class="grid grid-cols-3 gap-6">
            <!-- Column 1: Name, Picture, Total Cost -->
            <div class="text-center">
                <h3 class="font-bold text-lg mb-2 {% if not monster.unlocked %}text-gray-500{% endif %}">
                    {{ monster.name }}
                    {% if not monster.unlocked %}
                        <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded ml-2">LOCKED</span>
                    {% endif %}
                </h3>
                <div class="w-16 h-16 bg-gray-200 rounded-lg mx-auto mb-3 flex items-center justify-center">
                    <img src="{{ monster.image_url }}" alt="{{ monster.name }}" class="w-12 h-12 object-contain">
                </div>
                
                {% if not monster.unlocked %}
                    <div class="text-sm text-gray-600">
                        <div class="font-semibold mb-1">Unlock Cost:</div>
                        <div class="text-green-600">ðŸ§ª {{ monster.next_upgrade.putty }} putty</div>
                    </div>
                {% else %}
                    <!-- Calculate total cost for all remaining upgrades -->
                    <div class="text-sm text-gray-600">
                        <div class="font-semibold mb-1">Total to Max:</div>
                        <div class="text-green-600">ðŸ§ª {{ monster.instance_total_putty }} putty</div>
                        <div class="text-purple-600">ðŸ•° {{ monster.instance_total_time }}</div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Column 2: Current Level, Upgrade/Unlock Button -->
            <div class="text-center">
                {% if not monster.unlocked %}
                    <div class="mb-4">
                        <span class="text-lg text-gray-500">LOCKED</span>
                    </div>
                    <button 
                        hx-post="/api/upgrade/monster/{{ monster.id }}"
                        hx-target="#upgrade-result"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Unlock
                    </button>
                    <div class="text-xs text-gray-500 mt-2">{{ monster.next_upgrade.putty }} putty</div>
                {% else %}
                    <div class="mb-4">
                        <span class="text-2xl font-bold text-green-600">{{ monster.current_level }}</span>
                        <span class="text-gray-500">/</span>
                        <span class="text-lg text-gray-700">{{ monster.max_level }}</span>
                    </div>
                    
                    {% if monster.current_level < monster.max_level %}
                    <button 
                        hx-post="/api/upgrade/monster/{{ monster.id }}"
                        hx-target="#upgrade-result"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        {% if category == "locker" %}
                            Upgrade
                        {% elif category == "academy" %}
                            Train
                        {% elif category == "lab" %}
                            Enhance
                        {% endif %}
                    </button>
                    <!-- Time is now formatted by backend -->
                    <div class="text-xs text-gray-500 mt-2">ðŸ•° {{ monster.next_upgrade.time }}</div>
                    {% else %}
                    <div class="text-green-600 font-semibold">MAX LEVEL</div>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- Column 3: Upgrade Costs List -->
            <div class="text-sm">
                {% if not monster.unlocked %}
                    <div class="font-semibold mb-2">Unlock Requirements:</div>
                    <div class="text-gray-600">
                        <p class="mb-2">This monster is currently locked.</p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-2">
                            <div class="font-medium">Unlock Cost:</div>
                            <div class="text-green-600">ðŸ§ª {{ monster.next_upgrade.putty }} putty</div>
                        </div>
                    </div>
                {% else %}
                    <div class="font-semibold mb-2">Remaining Upgrades:</div>
                    {% if monster.current_level < monster.max_level %}
                        <!-- Fixed range calculation to avoid min() function and use proper data structure -->
                        {% set max_display = monster.current_level + 3 %}
                        {% if max_display > monster.max_level %}
                            {% set max_display = monster.max_level %}
                        {% endif %}
                        
                        {% for level in range(monster.current_level + 1, max_display + 1) %}
                            {% if monster.remaining_upgrades and loop.index0 < monster.remaining_upgrades|length %}
                                {% set upgrade = monster.remaining_upgrades[loop.index0] %}
                                <div class="py-1 border-b border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <span>Level {{ level }}:</span>
                                        <span class="text-green-600">ðŸ§ª{{ upgrade.putty }} ðŸ•°{{ upgrade.time }}</span>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        {% if monster.max_level - monster.current_level > 3 %}
                            <div class="text-xs text-gray-500 py-1">
                                ... and {{ monster.max_level - monster.current_level - 3 }} more upgrades
                            </div>
                        {% endif %}
                        
                        <!-- Use backend-calculated totals instead of template calculations -->
                        <div class="mt-3 pt-2 border-t border-gray-300 font-semibold">
                            <div class="flex justify-between">
                                <span>Total Cost:</span>
                                <div class="text-right">
                                    <div class="text-green-600">ðŸ§ª {{ monster.instance_total_putty }} putty</div>
                                    <div class="text-purple-600">ðŸ•° {{ monster.instance_total_time }}</div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-green-600 italic">All upgrades complete!</div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    
    {% if not monsters %}
    <div class="text-center py-8 text-gray-500">
        <p>No monsters found in {{ category }}.</p>
    </div>
    {% endif %}
</div>

<div id="upgrade-result"></div>
